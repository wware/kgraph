# Session status — 2026-02-12

Record of discussion and changes from this session (help.md follow-up, evidence/type enforcement, full-paper streaming extraction, Ollama/GPU).

---

## 1. Help.md to-dos

**Source:** `help.md` — next-step items from a prior review.

- **Item 1 — Type-constraint enforcement:** Enforce type constraints *before* emitting `final_relationships` and record in the relationship trace: `accepted: false`, `drop_reason: type_constraint_mismatch`.
- **Item 2 — Evidence enforcement:** Normalize evidence and subject/object names; require that *both* entity strings (or synonym matches) appear in the evidence; drop and record reason otherwise.
- **Item 3 — Doc-specific predicate filtering:** (Not implemented.) Only offer predicates valid for entity types in the document.

---

## 2. Type-constraint enforcement (item 1)

**Done:**

- Type constraints were already enforced in `_process_llm_item` in `examples/medlit/pipeline/relationships.py` before a relationship was added to the list that becomes `final_relationships`, with `drop_reason: "type_constraint_mismatch"` set.
- **Change:** The decision dict now sets `decision["accepted"] = False` explicitly on the type-constraint failure path so the trace always shows `accepted: false` for those rejections.

**Location:** `examples/medlit/pipeline/relationships.py` — type-constraint block in `_process_llm_item`.

---

## 3. Evidence enforcement (item 2)

**Done:**

- **Helpers** in `examples/medlit/pipeline/relationships.py`:
  - `_normalize_evidence_for_match(text)` — lowercase, strip, collapse whitespace.
  - `_evidence_contains_both_entities(evidence, subject_name, object_name, subject_entity, object_entity)` — returns `(ok, drop_reason, detail)`; `ok` only when both subject and object (or synonyms) appear in normalized evidence.
  - Possible `drop_reason`: `evidence_empty`, `evidence_missing_subject_and_object`, `evidence_missing_subject`, `evidence_missing_object`.
- **In `_process_llm_item`:** After resolving subject/object entities, we call `_evidence_contains_both_entities`, set `decision["evidence_check"] = detail`, and on failure set `decision["drop_reason"]` and return `None, decision` so the relationship is never accepted.
- **Tests** in `tests/test_relationship_swap.py`: `test_evidence_contains_both_entities_both_present`, `test_evidence_contains_both_entities_missing_subject`, `test_evidence_contains_both_entities_empty_evidence`, `test_evidence_contains_both_entities_synonym_match`.

---

## 4. Full-paper streaming extraction

**Goal:** Process the *entire* paper without loading it all into one string; present a sequence of overlapping section-based prompts for entity (and optionally relationship) extraction.

**Done:**

### 4.1 Streaming PMC chunker

**New file:** `examples/medlit/pipeline/pmc_streaming.py`

- **`iter_pmc_sections(raw_content)`** — Uses `iterparse`; yields `(section_id, text)` for abstract and each body `<sec>`. Elements cleared after yield to limit memory.
- **`iter_overlapping_windows(sections, window_size=4000, overlap=800)`** — Consumes section iterator; yields overlapping text windows (one window-sized buffer in memory). Optional first window = abstract only.
- **`iter_pmc_windows(raw_content, ...)`** — Convenience: `iter_pmc_sections` → `iter_overlapping_windows`; yields `(window_index, text)`.
- Defaults: 4000 chars per window, 800 overlap.

### 4.2 Entity extraction over full paper

- **Orchestrator** (`kgraph/ingest.py`): Passes `raw_content` and `content_type` into `entity_extractor.extract(document, raw_content=..., content_type=...)`.
- **MedLit entity extractor** (`examples/medlit/pipeline/mentions.py`):
  - When `raw_content` and `content_type` are present and XML (`application/xml` or `text/xml`): uses `iter_pmc_windows(raw_content)` to get windows, runs the same NER prompt on each (up to 8000 chars per prompt), merges/dedupes mentions by `(normalized name, entity type)` keeping highest confidence.
  - Otherwise: unchanged (single prompt on abstract or first 2000 chars).
- **Tests:** `tests/test_pmc_streaming.py` — `iter_pmc_sections`, `iter_overlapping_windows`, `iter_pmc_windows`.

---

## 5. Runs and observations

### 5.1 First full ingest run (PMC12770061)

- Command: `rm -f canonical_id_cache.json && uv run python -m examples.medlit.scripts.ingest --input-dir examples/medlit/pmc_xmls/ --use-ollama --ollama-timeout 1800 --input-papers 'PMC12770061.xml' --trace-all --debug`
- **Result:** 0 relationships. Trace showed: LLM proposed 15 relationships; all rejected — evidence enforcement (evidence_missing_subject/object, evidence_empty) and type_constraint_mismatch (e.g. disease→treats→disease). Only 4 entities (all diseases) from abstract-only extraction at that time.

### 5.2 XML / entity types

- User asked whether we should pull other entity types (not just diseases). **Finding:** Domain already supports disease, gene, drug, protein, symptom, procedure, biomarker, pathway, location, ethnicity. Entity extraction was only using the *abstract* (and first 2000 chars), so genes/procedures in the body were never seen. Full-paper streaming addresses that.

### 5.3 Ollama on CPU vs GPU

- User discovered Ollama was running on CPU on a GPU instance. **Check:** `/api/tags` does *not* indicate CPU vs GPU. Use Ollama logs or `nvidia-smi` under load.
- **Logs interpreted:** `library=CUDA`, `description="NVIDIA A10"`, `total="22.5 GiB"`, `vram-based default context` → Ollama using GPU (NVIDIA A10, CUDA).

### 5.4 Second full ingest run (after GPU fix)

- Same command; run hit 10-minute timeout but got much further:
  - **Entity extraction:** 62 windows (full paper), **374 unique entities** (merged from windows).
  - Timeout occurred during **embedding** phase (nomic-embed-text for 374 entities).
- Conclusion: Streaming full-paper entity extraction is working; GPU made entity phase complete in reasonable time; longer run needed to complete embeddings → promotion → relationships → export.

---

## 6. Files touched this session

- **Modified:** `examples/medlit/pipeline/relationships.py` (evidence + type_constraint), `examples/medlit/pipeline/mentions.py` (streaming extraction), `kgraph/ingest.py` (pass raw_content/content_type), `tests/test_relationship_swap.py` (evidence tests).
- **New:** `examples/medlit/pipeline/pmc_streaming.py`, `tests/test_pmc_streaming.py`.
- **Reference only:** `help.md` (to-dos), `examples/medlit/pmc_xmls/PMC12770061.xml` (large test paper).
- **Generated by runs:** `medlit_bundle/*`, `canonical_id_cache.json` (often not committed or in .gitignore).

---

## 7. Not done this session

- Doc-specific predicate filtering (help.md item 3).
- Windowed relationship extraction (optional: run relationship extraction per window, merge).
- Relaxing evidence matching (e.g. synonym/expansion like "HCRC" ↔ "hereditary colorectal cancer") if desired.
